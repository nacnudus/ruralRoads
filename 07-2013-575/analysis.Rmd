```{r setup, include = FALSE}
opts_chunk$set(echo = FALSE
               , warning = FALSE
               , message = FALSE
               , fig.width = 16 / 2.54
               , fig.height = 6
#               , dpi = 600 # use 600 for printing otherwise comment out
               , fig.cap = "")

tableStyle <- "rmarkdown" # for .docx use "multiline" otherwise "rmarkdown"
tableResults <- "asis"
excelPalette <- c("#4F81BD", "#C0504D", "#9BBB59", "#8064A2")
```

```{r function, include = FALSE}
source("R/01-function.r")
```

```{r source, include = FALSE, cache = TRUE}
source("R/02-load.r")
source("R/03-clean.r")
```

Rural Drink-Driving in the Bay of Plenty
========================================

All the crashes discussed in this document are fatal/serious-injury crashes.


### Numbers of crashes

Rural areas tend to have slightly more crashes than urban areas, both drink-drive and otherwise.  Drink-drive crashes are declining in both urban and rural areas.

```{r pureCrashesTable, results = tableResults, cache = TRUE}
x <- dcast(crashes, urbanRural + alcohol ~ year, length, value.var = "count")
colnames(x)[1:2] <- c("Urban/Rural", "Alcohol a Factor")
pandoc.table(x
             , caption = "Road in the Bay of Plenty (km)"
             ,style = tableStyle
             , split.tables = Inf)
```

```{r pureCrashes, cache = TRUE}
plotLabels <- list("TRUE" = "alcohol a factor"
  , "FALSE" = "alcohol not a factor")

plotLabeller <- function(variable, value) {
  return(plotLabels[value])
}

ggplot(crashes, aes(year, group = urbanRural, fill = urbanRural)) + 
 geom_bar(binwidth = 1, position = "dodge", colour = "black") + 
  facet_grid(. ~ alcohol, labeller = plotLabeller) +
  ggtitle("Number of Crashes\nby whether alcohol was a factor") +
  ylab("number of crashes") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = excelPalette)
```


### Crash rate per 1000 km of road

Roads have been divided into four categories, according to the type of road they are, and the area they are in.

* urban roads (excluding highways)
* urban highways
* rural roads (excluding highways)
* rural highways

```{r roadTable, results = tableResults, cache = TRUE}
pandoc.table(SummaryBoP[c("urban", "rural"), c("road", "highway")]
             , caption = "Road in the Bay of Plenty (km)"
             ,style = tableStyle
             , split.tables = Inf)
```

Urban highways have by far the worst fatal/serious crash rate, whether drink-drive-related or not.  This probably reflects the sheer volume of traffic on urban highways

```{r roadCrashRate, cache = TRUE}
ggplot(crashes, aes(year, weight = countRoad, group = urbanRuralRoadHighway
                    , fill = urbanRuralRoadHighway)) + 
  geom_bar(position = "dodge") + facet_wrap(.(alcohol), colour = "black") +
  ggtitle("Crashes per 1000 km\nby type of road\nand whether alcohol was a factor") +
  ylab("crashes per 1000 km") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = excelPalette)
```


### Crashes by population

Areas of the Bay of Plenty have been categorised into "urban" and "rural", based on a Statistics New Zealand dataset.  Demographic data are available giving the populations of urban and rural areas.  The rural population is considerably smaller than the urban population.

```{r populationTable, results = tableResults, cache = TRUE}
pandoc.table(data.frame("Region" = c("urban", "rural")
                        , Population = SummaryBoP[c("urban", "rural")
                                                  , "population"])
              , caption = "Population of the Bay of Plenty"
              ,style = tableStyle
             , split.tables = Inf)
```


The crash rate per head population in rural areas is much higher than in urban areas.  This is because, while the number of crashes in rural areas is slightly higher than in urban areas, the population is much smaller.  This is true of both drink-drive-related crashes and others.

```{r populationCrashRate, cache = TRUE}
plotLabels <- list(
  "TRUE" = "alcohol a factor"
  , "FALSE" = "alcohol not a factor"
  )

plotLabeller <- function(variable, value) {
  return(plotLabels[value])
}

ggplot(crashes, aes(year, weight = countPopulation, group = urbanRural
                    , fill = urbanRural)) + 
  geom_bar(position = "dodge", colour = "black") +
  facet_grid(. ~ alcohol, labeller = plotLabeller) +
  ggtitle("Crashes per 1000 people\nby urban/rural and whether\nalcohol was a factor") +
  ylab("number of crashes per 1000 people") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = excelPalette)
```

Compare with the first graph, "Number of Crashes".  Weighting by population is a fairer estimation of the rural drink-drive problem.  A better weighting would take into account the number of licenced drivers and distance driven, however these data are not available.


### Time of day of crashes

Drink-drive-related crashes tend to occur in the evenings and early mornings.  Drink-drive-crashes become a problem earlier in the evening in rural areas than in urban areas.

```{r crashesHourlyByNumber, cache = TRUE}
ggplot(crashes[!is.na(crashes$hour) & crashes$alcohol == TRUE, ]
       , aes(hour, weight = count
             , fill = as.character(excelPalette[1]))) + 
  geom_bar(binwidth = 1, colour = "black") +
  scale_x_discrete(breaks = seq(0,24,4)) +
  facet_grid(urbanRural ~ .) +
  ggtitle("Crashes where Alcohol was a Factor\nby hour of the day") +
  ylab("number of crashes") +
  theme(legend.position="none") +
  scale_fill_manual(values = excelPalette)
```


Alcohol is not a factor in most crashes.  However, after 8.00 pm, it is a factor in about 40-65% of crashes.

```{r crashesHourlyCaption, include = FALSE, cache = TRUE}
crashesHourlyCaption <- "The bars indicate the percentage of all crashes that were drink-drive-related in that hour of the day, in that region, e.g. the right-most bar of the top graph shows that over 60% of rural crashes between 2300 hours and midnight were drink-driver related."
```

```{r crashesHourlyByPercentage, fig.cap = crashesHourlyCaption, cache = TRUE}
# crashes that are drink-drive-related, as a percentage of all crashes
ggplot(crashes[!is.na(crashes$hour) & crashes$alcohol == TRUE, ]
       , aes(hour, weight = countCrashUrbanHour
             , fill = as.character(excelPalette[1]))) + 
  geom_bar(binwidth = 1, colour = "black") +
  scale_x_discrete(breaks = seq(0,24,4)) +
  facet_grid(urbanRural ~ .) +
  ggtitle("% of Crashes where Alcohol was a Factor\nby hour of the day") +
  ylab("% of crashes") +
  theme(legend.position="none") +
  theme(panel.margin = unit(0, "pt")) +
  scale_fill_manual(values = excelPalette)
```


The nights with the highest percentage of drink-drive crashes are Friday, Saturday and Sunday nights.  Mondays are also high in urban areas.  Tuesdays and Wednesdays have the lowest.

```{r crashesWeekly, cache = TRUE}
# make a copy of the crashes
x <- crashes
# centre on Thursday for plotting
x$weekday <- factor(x$weekday, levels = c("Wednesday"
                                          , "Thursday", "Friday"
                                          , "Saturday", "Sunday"
                                          , "Monday", "Tuesday"))
ggplot(x[!is.na(x$hour) 
         & x$alcohol == TRUE, ]
       , aes(hour, weight = countCrashUrbanWeekdayHour3
             , fill = as.character(excelPalette[1]))) + 
  geom_histogram(binwidth = 3, colour = "black") +
  scale_x_continuous(breaks = seq(0, 24 ,6), expand = c(0, 0), limits = c(0, 24)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(urbanRural ~ weekday) +
  ggtitle("% of Crashes where Alcohol was a Factor\nby weekday and hour of the day") +
  xlab("hour of the day (in three-hour groups)") +
  ylab("% of crashes") +
  theme(legend.position="none") +
  theme(panel.margin = unit(0, "pt")
        , panel.border = element_rect(colour = "black", fill = "transparent")) +
  scale_fill_manual(values = excelPalette)
# tidy
rm(x)
```


### Age / ethnicity of drivers-at-fault

The rate of drink-drive-crashes is highest for the 20-25 age group in both rural and urban areas.  The rate for the 15-20 age group is higher in rural areas than urban areas, and the rate does not drop off as markedly after age 25 in rural areas, but continues to be relatively high up to age 45.

```{r age, cache = TRUE}
x <- drivers[!is.na(drivers$age) & drivers$fault == TRUE & drivers$alcohol == TRUE, ]
ggplot(x, aes(age, weight = countAgeGroupPopulation
              , fill = as.character(excelPalette[1]))) +
  geom_histogram(binwidth = 5, colour = "black") +
  scale_x_continuous(breaks = seq(20, 80, 10), limits = c(15, max(x$age))) +
  facet_grid(urbanRural ~ .) +
  ggtitle("Drink-Drivers in Crashes per Population\nby age in 5-year bands") +
  xlab("age in 5-year bands") +
  ylab("number of drink-drivers in crashes per 1000 population") +
  theme(legend.position="none") +
  scale_fill_manual(values = excelPalette)
# tidy
rm(x)
```



The ethnicities with the highest number of drink-drivers at fault in crashes, per head population, are by far NZ Maori and Pacific Islander.  The difference is even more marked in rural areas than in urban areas, though there are more drink-drivers at fault in crashes in rural areas generally, per head population, compared with urban areas.

```{r ethnicityTableDrivers, results = tableResults, cache = TRUE, }
x <- ddply(drivers[drivers$fault == TRUE & drivers$alcohol == TRUE, ]
           , .(ethnicity, urbanRural), function(x) (sum(x$count)))
x <- dcast(x, ethnicity ~ urbanRural, sum, margins = TRUE)
# nicer Total row and column headings
colnames(x) <- c("Ethnicity", "Rural Drivers", "Urban Drivers", "Total")
x$Ethnicity <- as.character(x$Ethnicity)
x$Ethnicity[nrow(x)] <- "Total"
# remove row names because pander can't ignore them
rownames(x) <- NULL
# print
pandoc.table(x, caption = "Drink-Drivers At Fault by Ethnicity"
             , emphasize.strong.rows = 5, emphasize.strong.cols = 4
             , justify = c("left", "right", "right", "right")
             , style = tableStyle
             , split.tables = Inf)
# tidy
rm(x)
```

```{r ethnicityTablePopulation, results = tableResults, cache = TRUE}
x <- dcast(mDataBoP[mDataBoP$variable %in% c("European", "NZ Maori", "Other"
                                        , "Pacific Islander"), ]
      , variable ~ urbanRural, sum, na.rm = TRUE, margins = TRUE)
# remove NA column
x <- x[, -4]
# order alphabetically leaving (all) at the bottom
x$variable <- as.character(x$variable)
x <- x[c(order(x$variable)[2:5], 5), ]
# nicer Total row and column headings
x$variable[length(x$variable)] <- "Total"
colnames(x) <- c("Ethnicity", "Rural Population", "Urban Population", "Total")
# remove row names because pander can't ignore them
rownames(x) <- NULL
# print
pandoc.table(x, caption = "Population by Ethnicity"
             , emphasize.strong.rows = 5, emphasize.strong.cols = 4
             , justify = c("left", "right", "right", "right")
             , style = tableStyle
             , split.tables = Inf)
# tidy
rm(x)
```

```{r ethnicity, cache = TRUE}
x <- drivers[!is.na(drivers$age) & drivers$fault == TRUE & drivers$alcohol == TRUE, ]
ggplot(x, aes(ethnicity, weight = countUrbanEthnicity
              , fill = ethnicity)) +
  geom_bar(colour = "black") + 
  facet_grid(. ~ urbanRural) +
  ggtitle("Drink-Drivers in Crashes per Population\nby urban/rural and ethnicity") +
  xlab("age in 5-year bands") +
  ylab("number of drink-drivers in crashes per 1000 population") +
  theme(legend.position="none") +
  scale_fill_manual(values = excelPalette)
# tidy
rm(x)
```


### Discussion

The perception that drink-driving is a problem in rural areas is probably driven by the ratio of crashes to population.  In fact, there are only slightly more drink-drive crashes in rural areas than in urban areas.

It may be impractical to address rural drink-driving by enforcement, because there is so much road to police.  It may be more practical to engage with the community, because the community is small.