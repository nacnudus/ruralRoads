```{r setup, include = FALSE}
opts_chunk$set(echo = FALSE
               , warning = FALSE
               , message = FALSE
               , fig.width = 7
               , fig.height = 6
               , fig.cap = "")

tableStyle <- "rmarkdown" # for .docx use "multiline" otherwise "rmarkdown"
tableResults <- "asis" # for .docx use "markup"? otherwise "asis"
excelPalette <- c("#4F81BD", "#C0504D", "#9BBB59", "#8064A2")
```

```{r function, include = FALSE}
source("R/01-function.r")
```

```{r source, include = FALSE, cache = TRUE}
source("R/02-load.r")
source("R/03-clean.r")
```

Rural Drink-Driving in the Bay of Plenty
========================================

All the crashes discussed in this document are fatal/serious-injury crashes.


### Numbers of crashes

Rural areas tend to have slightly more crashes than urban areas, both drink-drive and otherwise.  Drink-drive crashes are declining in both urban and rural areas.

```{r pureCrashes, cache = TRUE}
plotLabels <- list("TRUE" = "alcohol a factor"
  , "FALSE" = "alcohol not a factor")

plotLabeller <- function(variable, value) {
  return(plotLabels[value])
}

ggplot(crashes, aes(year, group = urbanRural, fill = urbanRural)) + 
 geom_bar(binwidth = 1, position = "dodge") + 
  facet_grid(. ~ alcohol, labeller = plotLabeller) +
  ggtitle("Number of Crashes\nby whether alcohol was a factor") +
  ylab("number of crashes") +
  theme(legend.title = element_blank()) +
  scale_fill_manual(values = excelPalette)
```


### Crash rate per 1000 km of road

Roads have been divided into four categories, according to the type of road they are, and the area they are in.

* urban roads (excluding highways)
* urban highways
* rural roads (excluding highways)
* rural highways

```{r roadTable, results = tableResults, cache = TRUE}
pandoc.table(SummaryBoP[c("urban", "rural"), c("road", "highway")]
             , caption = "Road in the Bay of Plenty (km)"
             ,style = tableStyle)
```

Urban highways have by far the worst fatal/serious crash rate, whether drink-drive-related or not.  This probably reflects the sheer volume of traffic on urban highways

```{r roadCrashRate, cache = TRUE}
ggplot(crashes, aes(year, weight = countRoad, group = urbanRuralRoadHighway
                    , fill = urbanRuralRoadHighway)) + 
  geom_bar(position = "dodge") + facet_wrap(.(alcohol))
```


### Crashes by population

Areas of the Bay of Plenty have been categorised into "urban" and "rural", based on a Statistics New Zealand dataset.  Demographic data are available giving the populations of urban and rural areas.  The rural population is considerably smaller than the urban population.

```{r populationTable, results = tableResults, cache = TRUE}
pandoc.table(data.frame(Urban.or.Rural = c("urban", "rural")
                        , Population = SummaryBoP[c("urban", "rural")
                                                  , "population"])
              , caption = "Population of the Bay of Plenty"
              ,style = tableStyle)
```


The crash rate per head population in rural areas is much higher than in urban areas.  This is because, while the number of crashes in rural areas is slightly higher than in urban areas, the population is much smaller.  This is true of both drink-drive-related crashes and others.

```{r populationCrashRate, cache = TRUE}
ggplot(crashes, aes(year, weight = countPopulation, group = urbanRural
                    , fill = urbanRural)) + 
  geom_bar(position = "dodge") + facet_wrap(.(alcohol))
```


### Time of day of crashes

Drink-drive-related crashes tend to occur in the evenings and early mornings.  Drink-drive-crashes become a problem earlier in the evening in rural areas than in urban areas.

```{r crashesHourly, cache = TRUE}
# Percentage of all crashes that are drink-drive-related
ggplot(crashes[!is.na(crashes$hour) & crashes$alcohol == TRUE, ]
       , aes(factor(hour), weight = countCrashUrbanHour)) + 
  geom_bar() +
  scale_x_discrete(breaks = seq(0,24,4)) +
  facet_grid(urbanRural ~ .)
```

The nights with the highest number of drink-drive crashes are Saturday and Sunday nights.  Fridays and Mondays also have many crashes.  Tuesdays and Wednesdays have the fewest.

```{r crashesWeekly, cache = TRUE}
# make a copy of the crashes
x <- crashes
# centre on Thursday for plotting
x$weekday <- factor(x$weekday, levels = c("Wednesday"
                                          , "Thursday", "Friday"
                                          , "Saturday", "Sunday"
                                          , "Monday", "Tuesday"))
ggplot(x[!is.na(x$hour) 
         & x$alcohol == TRUE 
         & x$urbanRural == "rural", ]
       , aes(hour, weight = countCrashUrbanWeekdayHour)) + 
  geom_histogram(binwidth = 3) +
  scale_x_continuous(breaks = seq(0, 24 ,6), expand = c(0, 0), limits = c(0, 24)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(. ~ weekday) +
  theme(panel.margin = unit(0, "pt")
        , panel.border = element_rect(colour = "black", fill = "transparent"))
# tidy
rm(x)
```

```{r crashesWeeklyCircular, cache = TRUE}
# note: pure, unweighted crash counts
# prepare the data
x <- crashes[!is.na(crashes$hour) 
               & crashes$alcohol == TRUE 
               & crashes$urbanRural == "rural", ]
# turn hours of the day into hours of the week
x <- (24 * as.integer(x$weekday)) + as.integer(x$hour) - 24
# round down to the nearest three hours (midnight, 0300, 0900, etc.) for
# stacking
x <- seq(0, 167, 3)[findInterval(x, seq(0, 167, 3))]
# convert hours degrees of a circle
x <- x / 168 * 360
# create circular object
x <- circular(x, units = "degrees", template = "geographics")
# make space for the plot
par(mar = c(0,0,0,0))
# plot
plot(x, stack = TRUE, shrink = 1.5, sep = 0.05, axes = FALSE)
# smooth (a better smooth than ggplot)
lines(density(x, bw = 200, ), col='RoyalBlue', lwd = 2)
# prepare seven axis ticks and labels
y <- circular(seq(0, 360 - 360 / 7, 360 / 7), units = "degrees"
              , template = "geographics")
# apply the ticks, noting workaround for strange bu
axis.circular(at=y - 90 + (360 / 14), labels= rep("", 7), cex=0.6, tcl = 1)
# apply the labels between the ticks, working around the bug the opposite way
axis.circular(at=-y + 90 - (360 / 14)
              , labels=levels(crashes$weekday)
              , cex=0.6
              , tick = FALSE)
# tidy up
par(mar = c(5, 4, 4, 2) + 0.1) # reset to default
rm(x, y)
```

### Age / ethnicity of drivers-at-fault

The rate of drink-drive-crashes is highest for the 20-25 age group in both rural and urban areas.  The rate for the 15-20 age group is higher in rural areas than urban areas, and the rate does not drop off as markedly after age 25 in rural areas, but continues to be relatively high up to age 45.

```{r age, cache = TRUE}
x <- drivers[!is.na(drivers$age) & drivers$fault == TRUE & drivers$alcohol == TRUE, ]
ggplot(x, aes(age, weight = countAgeGroupPopulation)) +
  geom_histogram(binwidth = 5) +
  scale_x_continuous(breaks = seq(20, 80, 10), limits = c(15, max(x$age))) +
  facet_grid(urbanRural ~ .)
# tidy
rm(x)
```



The ethnicities with the highest number of drink-drivers at fault in crashes, per head population, are by far NZ Maori and Pacific Islander.  The difference is even more marked in rural areas than in urban areas, though there are more drink-drivers at fault in crashes in rural areas generally, per head population, compared with urban areas.

```{r ethnicityTableDrivers, results = tableResults, cache = TRUE, }
x <- ddply(drivers[drivers$fault == TRUE & drivers$alcohol == TRUE, ]
           , .(ethnicity, urbanRural), function(x) (sum(x$count)))
x <- dcast(x, ethnicity ~ urbanRural, sum, margins = TRUE)
# nicer Total row and column headings
colnames(x) <- c("Ethnicity", "Rural Drivers", "Urban Drivers", "Total")
x$Ethnicity <- as.character(x$Ethnicity)
x$Ethnicity[nrow(x)] <- "Total"
# remove row names because pander can't ignore them
rownames(x) <- NULL
# print
pandoc.table(x, caption = "Drink-Drivers At Fault by Ethnicity"
             , emphasize.strong.rows = 5, emphasize.strong.cols = 4
             , justify = c("left", "right", "right", "right")
             , style = tableStyle
             , split.tables = Inf)
# tidy
rm(x)
```

```{r ethnicityTablePopulation, results = tableResults, cache = TRUE}
x <- dcast(mDataBoP[mDataBoP$variable %in% c("European", "NZ Maori", "Other"
                                        , "Pacific Islander"), ]
      , variable ~ urbanRural, sum, na.rm = TRUE, margins = TRUE)
# remove NA column
x <- x[, -4]
# order alphabetically leaving (all) at the bottom
x$variable <- as.character(x$variable)
x <- x[c(order(x$variable)[2:5], 5), ]
# nicer Total row and column headings
x$variable[length(x$variable)] <- "Total"
colnames(x) <- c("Ethnicity", "Rural Population", "Urban Population", "Total")
# remove row names because pander can't ignore them
rownames(x) <- NULL
# print
pandoc.table(x, caption = "Population by Ethnicity"
             , emphasize.strong.rows = 5, emphasize.strong.cols = 4
             , justify = c("left", "right", "right", "right")
             , style = tableStyle
             , split.tables = Inf)
# tidy
rm(x)
```

```{r ethnicity, cache = TRUE}
x <- drivers[!is.na(drivers$age) & drivers$fault == TRUE & drivers$alcohol == TRUE, ]
ggplot(x, aes(ethnicity, weight = countUrbanEthnicity)) +
  geom_bar() + 
  facet_grid(. ~ urbanRural)
# tidy
rm(x)
```


### Discussion

The perception that drink-driving is a problem in rural areas is probably driven by the ratio of crashes to population.  In fact, there are only slightly more drink-drive crashes in rural areas than in urban areas.

It may be impractical to address rural drink-driving by enforcement, because there is so much road to police.  It may be more practical to engage with the community, because the community is small.